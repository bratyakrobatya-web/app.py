"""
–ú–æ–¥—É–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è VR –ú—É–ª—å—Ç–∏—Ç—É–ª

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è:
- –ó–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API HH.ru
- –û–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Å–µ–ª–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–æ–≤
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –≥–æ—Ä–æ–¥–æ–≤ –∏ —Ä–µ–≥–∏–æ–Ω–æ–≤
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã—Ö –æ–∫—Ä—É–≥–æ–≤
"""

from typing import Dict, Optional, List
import pandas as pd
import requests
import streamlit as st

# Security utilities
from security_utils import (
    logger,
    log_security_event
)

# Safe file operations
from safe_file_utils import safe_read_csv

# City matching module
from modules.matching import normalize_city_name

# Requests exceptions
from requests.exceptions import RequestException, Timeout, HTTPError


# ============================================
# –ö–û–ù–°–¢–ê–ù–¢–´
# ============================================

FEDERAL_DISTRICTS = {
    "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥": [
        "–ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ë—Ä—è–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ò–≤–∞–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ö–∞–ª—É–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ö—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–°–º–æ–ª–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–¢–∞–º–±–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–¢–≤–µ—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–¢—É–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ú–æ—Å–∫–≤–∞"
    ],
    "–Æ–∂–Ω—ã–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥": [
        "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–¥—ã–≥–µ—è", "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞–ª–º—ã–∫–∏—è", "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö—Ä—ã–º",
        "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π", "–ê—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å"
    ],
    "–°–µ–≤–µ—Ä–æ-–ó–∞–ø–∞–¥–Ω—ã–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥": [
        "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞—Ä–µ–ª–∏—è", "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–æ–º–∏", "–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–ú—É—Ä–º–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ù–µ–Ω–µ—Ü–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥"
    ],
    "–î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω—ã–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥": [
        "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë—É—Ä—è—Ç–∏—è", "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –°–∞—Ö–∞ (–Ø–∫—É—Ç–∏—è)", "–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π",
        "–ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π", "–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π", "–•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π",
        "–ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–ï–≤—Ä–µ–π—Å–∫–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –æ–±–ª–∞—Å—Ç—å", "–ß—É–∫–æ—Ç—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥"
    ],
    "–°–∏–±–∏—Ä—Å–∫–∏–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥": [
        "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–ª—Ç–∞–π", "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢—ã–≤–∞", "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –•–∞–∫–∞—Å–∏—è",
        "–ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π", "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π", "–ò—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–û–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–¢–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
    ],
    "–£—Ä–∞–ª—å—Å–∫–∏–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥": [
        "–ö—É—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥ ‚Äî –Æ–≥—Ä–∞",
        "–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥"
    ],
    "–ü—Ä–∏–≤–æ–ª–∂—Å–∫–∏–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥": [
        "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω", "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ú–∞—Ä–∏–π –≠–ª", "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ú–æ—Ä–¥–æ–≤–∏—è",
        "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω", "–£–¥–º—É—Ä—Ç—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞", "–ß—É–≤–∞—à—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞",
        "–ö–∏—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–ü–µ–Ω–∑–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π", "–°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
        "–°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–£–ª—å—è–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
    ],
    "–°–µ–≤–µ—Ä–æ-–ö–∞–≤–∫–∞–∑—Å–∫–∏–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥": [
        "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –î–∞–≥–µ—Å—Ç–∞–Ω", "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ò–Ω–≥—É—à–µ—Ç–∏—è", "–ö–∞–±–∞—Ä–¥–∏–Ω–æ-–ë–∞–ª–∫–∞—Ä—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞",
        "–ö–∞—Ä–∞—á–∞–µ–≤–æ-–ß–µ—Ä–∫–µ—Å—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞", "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –°–µ–≤–µ—Ä–Ω–∞—è –û—Å–µ—Ç–∏—è ‚Äî –ê–ª–∞–Ω–∏—è",
        "–ß–µ—á–µ–Ω—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞", "–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π"
    ]
}


# ============================================
# –§–£–ù–ö–¶–ò–ò –ó–ê–ì–†–£–ó–ö–ò –î–ê–ù–ù–´–•
# ============================================

def get_hh_areas() -> Optional[Dict]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏–∑ API HeadHunter

    –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å –∫ API HH.ru —Å:
    - –¢–∞–π–º–∞—É—Ç–æ–º –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è
    - –ü—Ä–æ–≤–µ—Ä–∫–æ–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    - –í–∞–ª–∏–¥–∞—Ü–∏–µ–π Content-Type
    - –í–∞–ª–∏–¥–∞—Ü–∏–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
    - –ü–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫

    Returns:
        Optional[Dict]: –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ {–Ω–∞–∑–≤–∞–Ω–∏–µ: {id, name, parent, ...}}
                       –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏

    Examples:
        >>> areas = get_hh_areas()
        >>> if areas:
        ...     moscow = areas.get('–ú–æ—Å–∫–≤–∞')
        ...     print(moscow['id'])  # '1'
    """
    url = 'https://api.hh.ru/areas'

    try:
        logger.info(f"–ó–∞–ø—Ä–æ—Å –∫ API HH: {url}")

        # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å
        response = requests.get(
            url,
            timeout=10,          # –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è
            verify=True,         # –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
            headers={
                'User-Agent': 'VRMultitool/3.3.2',
                'Accept': 'application/json'
            }
        )

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP —Å—Ç–∞—Ç—É—Å–∞
        response.raise_for_status()

        # –í–∞–ª–∏–¥–∞—Ü–∏—è Content-Type
        content_type = response.headers.get('Content-Type', '')
        if 'application/json' not in content_type:
            raise ValueError(f"–ù–µ–≤–µ—Ä–Ω—ã–π Content-Type: {content_type}")

        data = response.json()

        # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
        if not isinstance(data, list):
            raise ValueError("API –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö")

        logger.info(f"–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç API HH ({len(data)} —Ä–µ–≥–∏–æ–Ω–æ–≤)")

    except Timeout:
        error_msg = "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç API HH.ru"
        logger.error(error_msg)
        log_security_event('api_timeout', url, 'ERROR')
        st.error(f"‚è±Ô∏è {error_msg}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return None

    except HTTPError as e:
        error_msg = f"–û—à–∏–±–∫–∞ HTTP {e.response.status_code}"
        logger.error(f"{error_msg}: {url}")
        log_security_event('api_http_error', f"{url}: {error_msg}", 'ERROR')
        st.error(f"üåê –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç HH.ru (–∫–æ–¥ {e.response.status_code})")
        return None

    except ValueError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç API: {e}")
        log_security_event('api_validation_error', str(e), 'ERROR')
        st.error("üìä –ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç API")
        return None

    except RequestException as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API: {e}")
        log_security_event('api_network_error', str(e), 'ERROR')
        st.error("üåê –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.")
        return None

    except Exception as e:
        logger.critical(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API: {e}", exc_info=True)
        log_security_event('api_unexpected_error', str(e), 'CRITICAL')
        st.error("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞")
        return None

    areas_dict = {}

    def parse_areas(areas, parent_name="", parent_id="", root_parent_id=""):
        """
        –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø–∞—Ä—Å–∏—Ç –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–≥–∏–æ–Ω–æ–≤

        Args:
            areas: –°–ø–∏—Å–æ–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
            parent_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
            parent_id: ID —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
            root_parent_id: ID –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ (—Å—Ç—Ä–∞–Ω—ã)
        """
        for area in areas:
            area_id = area['id']
            area_name = area['name']

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π parent_id (—Å—Ç—Ä–∞–Ω—É)
            current_root_id = root_parent_id if root_parent_id else parent_id if parent_id else area_id

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –æ–±—ä–µ–∫—Ç–∞
            utc_offset = area.get('utc_offset', '')

            areas_dict[area_name] = {
                'id': area_id,
                'name': area_name,
                'parent': parent_name,
                'parent_id': parent_id,
                'root_parent_id': current_root_id,  # ID —Å—Ç—Ä–∞–Ω—ã –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è
                'utc_offset': utc_offset  # –°–º–µ—â–µ–Ω–∏–µ UTC (–Ω–∞–ø—Ä–∏–º–µ—Ä, "+03:00")
            }

            if area.get('areas'):
                parse_areas(area['areas'], area_name, area_id, current_root_id)

    parse_areas(data)
    return areas_dict


@st.cache_data(ttl=3600)
def load_population_data() -> Dict[str, int]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞—Å–µ–ª–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–æ–≤ –∏–∑ CSV —Ñ–∞–π–ª–∞

    –§—É–Ω–∫—Ü–∏—è –∫—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 1 —á–∞—Å –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ CSV —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç Path Traversal.

    Returns:
        Dict[str, int]: –°–ª–æ–≤–∞—Ä—å {–Ω–∞–∑–≤–∞–Ω–∏–µ_–≥–æ—Ä–æ–¥–∞: –Ω–∞—Å–µ–ª–µ–Ω–∏–µ} –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å
                       –ø—Ä–∏ –æ—à–∏–±–∫–µ

    Examples:
        >>> pop_data = load_population_data()
        >>> moscow_pop = pop_data.get('–ú–æ—Å–∫–≤–∞', 0)
        >>> print(f"–ù–∞—Å–µ–ª–µ–Ω–∏–µ –ú–æ—Å–∫–≤—ã: {moscow_pop}")
    """
    try:
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ CSV —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç Path Traversal
        df = safe_read_csv('population.csv', sep=';', encoding='utf-8')

        if df is None:
            logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª population.csv")
            return {}

        # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å {–≥–æ—Ä–æ–¥: –Ω–∞—Å–µ–ª–µ–Ω–∏–µ}
        population_dict = {}
        for _, row in df.iterrows():
            city_name = row['–ì–û–†–û–î–ê']
            population = int(row['–ù–∞—Å–µ–ª–µ–Ω–∏–µ'])
            population_dict[city_name] = population

        return population_dict
    except FileNotFoundError:
        st.warning("‚ö†Ô∏è –§–∞–π–ª population.csv –Ω–µ –Ω–∞–π–¥–µ–Ω. –§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—é –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
        return {}
    except Exception as e:
        st.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Å–µ–ª–µ–Ω–∏–∏: {str(e)}")
        return {}


# ============================================
# –§–£–ù–ö–¶–ò–ò –û–ë–†–ê–ë–û–¢–ö–ò –†–ï–ì–ò–û–ù–û–í –ò –ì–û–†–û–î–û–í
# ============================================

def get_federal_district_by_region(region_name: str) -> str:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ä–µ–≥–∏–æ–Ω–∞

    Args:
        region_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å")

    Returns:
        str: –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–≥–∞ –∏–ª–∏ "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω"

    Examples:
        >>> get_federal_district_by_region("–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å")
        '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥'
        >>> get_federal_district_by_region("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–≥–∏–æ–Ω")
        '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'
    """
    for district, regions in FEDERAL_DISTRICTS.items():
        if region_name in regions:
            return district
    return "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω"


def normalize_region_name(text: str) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

    –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è:
    - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ—Ä–æ–¥–∞ (—ë->–µ, lowercase, whitespace)
    - –ó–∞–º–µ–Ω–∞ –æ–∫–æ–Ω—á–∞–Ω–∏–π –æ–±–ª–∞—Å—Ç–µ–π –Ω–∞ –∫–æ—Ä–µ–Ω—å (–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è -> –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥)
    - –£–¥–∞–ª–µ–Ω–∏–µ —Å–ª–æ–≤ "–æ–±–ª–∞—Å—Ç—å", "–∫—Ä–∞–π", "—Ä–µ—Å–ø—É–±–ª–∏–∫–∞"

    Args:
        text: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

    Returns:
        str: –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞

    Examples:
        >>> normalize_region_name("–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å")
        '–º–æ—Å–∫–æ–≤'
        >>> normalize_region_name("–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª.")
        '–ª–µ–Ω–∏–Ω–≥—Ä–∞–¥'
    """
    text = normalize_city_name(text)  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é —Å —ë->–µ
    replacements = {
        '–ª–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è': '–ª–µ–Ω–∏–Ω–≥—Ä–∞–¥',
        '–º–æ—Å–∫–æ–≤—Å–∫–∞—è': '–º–æ—Å–∫–æ–≤',
        '–∫—É—Ä—Å–∫–∞—è': '–∫—É—Ä—Å–∫',
        '–∫–µ–º–µ—Ä–æ–≤—Å–∫–∞—è': '–∫–µ–º–µ—Ä–æ–≤',
        '—Å–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è': '—Å–≤–µ—Ä–¥–ª–æ–≤',
        '–Ω–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è': '–Ω–∏–∂–µ–≥–æ—Ä–æ–¥',
        '–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è': '–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫',
        '—Ç–∞–º–±–æ–≤—Å–∫–∞—è': '—Ç–∞–º–±–æ–≤',
        '–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∞—è': '–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫',
        '–æ–±–ª–∞—Å—Ç—å': '',
        '–æ–±–ª': '',
        '–∫—Ä–∞–π': '',
        '—Ä–µ—Å–ø—É–±–ª–∏–∫–∞': '',
        '—Ä–µ—Å–ø': '',
        '  ': ' '
    }
    for old, new in replacements.items():
        text = text.replace(old, new)
    return text.strip()


def get_cities_by_regions(hh_areas: Dict, selected_regions: List[str]) -> pd.DataFrame:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –≥–æ—Ä–æ–¥–∞ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤ (—Ç–æ–ª—å–∫–æ –†–æ—Å—Å–∏—è, —Ç–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–∞)

    –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ HH.ru –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:
    - –¢–æ–ª—å–∫–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –†–æ—Å—Å–∏–∏ (root_parent_id == '113')
    - –ò—Å–∫–ª—é—á–∞–µ—Ç –æ–±–ª–∞—Å—Ç–∏, –∫—Ä–∞—è, —Ä–µ—Å–ø—É–±–ª–∏–∫–∏, –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–µ –æ–∫—Ä—É–≥–∞
    - –ò—Å–∫–ª—é—á–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–∏–∑ excluded_names_normalized)
    - –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ä–µ–≥–∏–æ–Ω–∞–º
    - –î–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞—Å–µ–ª–µ–Ω–∏–∏, —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–∞—Ö, —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã—Ö –æ–∫—Ä—É–≥–∞—Ö
    - –£–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é

    Args:
        hh_areas: –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤ HH.ru (–∏–∑ get_hh_areas)
        selected_regions: –°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

    Returns:
        pd.DataFrame: DataFrame —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏:
                     - –ì–æ—Ä–æ–¥: –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
                     - ID HH: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ HH.ru
                     - –†–µ–≥–∏–æ–Ω: –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞
                     - –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥: –Ω–∞–∑–≤–∞–Ω–∏–µ –§–û
                     - UTC: —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
                     - –†–∞–∑–Ω–∏—Ü–∞ —Å –ú–°–ö: —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —á–∞—Å–∞—Ö —Å –ú–æ—Å–∫–≤–æ–π
                     - –ù–∞—Å–µ–ª–µ–Ω–∏–µ: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—è

    Examples:
        >>> areas = get_hh_areas()
        >>> df = get_cities_by_regions(areas, ["–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"])
        >>> print(df[['–ì–æ—Ä–æ–¥', '–†–µ–≥–∏–æ–Ω']].head())
    """
    cities = []

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞—Å–µ–ª–µ–Ω–∏–∏
    population_dict = load_population_data()

    # –°–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π - —á—Ç–æ –Ω–µ –≤—ã–≥—Ä—É–∂–∞—Ç—å (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è)
    excluded_names_normalized = [
        normalize_city_name('–†–æ—Å—Å–∏—è'),
        normalize_city_name('–î—Ä—É–≥–∏–µ —Ä–µ–≥–∏–æ–Ω—ã'),
        normalize_city_name('–î—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω—ã'),
        normalize_city_name('–ß—É–∫–æ—Ç—Å–∫–∏–π –ê–û'),
        normalize_city_name('–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û'),
        normalize_city_name('–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û'),
        normalize_city_name('–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û - –Æ–≥—Ä–∞'),
        normalize_city_name('–ï–≤—Ä–µ–π—Å–∫–∞—è –ê–û'),
        normalize_city_name('–ë–µ–ª–æ–≤—Å–∫–æ–µ'),
        normalize_city_name('–ì–æ—Ä—å–∫–∞—è –ë–∞–ª–∫–∞')
    ]

    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ —Ä–µ–≥–∏–æ–Ω, –∞ –Ω–µ –≥–æ—Ä–æ–¥
    region_keywords = ['–æ–±–ª–∞—Å—Ç—å', '–∫—Ä–∞–π', '—Ä–µ—Å–ø—É–±–ª–∏–∫–∞', '–æ–∫—Ä—É–≥', '–∞–≤—Ç–æ–Ω–æ–º–Ω']

    # ID –†–æ—Å—Å–∏–∏
    russia_id = '113'

    for city_name, city_info in hh_areas.items():
        parent = city_info['parent']
        root_parent_id = city_info.get('root_parent_id', '')

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å—ë, —á—Ç–æ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –†–æ—Å—Å–∏–∏
        if root_parent_id != russia_id:
            continue

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
        city_name_normalized = normalize_city_name(city_name)

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)
        if city_name_normalized in excluded_names_normalized:
            continue

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–ª–∞—Å—Ç–∏, –∫—Ä–∞—è, —Ä–µ—Å–ø—É–±–ª–∏–∫–∏
        if not parent or parent == '–†–æ—Å—Å–∏—è':
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ–±–ª–∞—Å—Ç—å—é/–∫—Ä–∞–µ–º/—Ä–µ—Å–ø—É–±–ª–∏–∫–æ–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
            is_region = any(keyword in city_name_normalized for keyword in region_keywords)
            if is_region:
                continue

            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ "–ê–û" –∏ —ç—Ç–æ –Ω–µ –≥–æ—Ä–æ–¥
            if city_name.endswith(' –ê–û') or city_name.endswith('–ê–û'):
                continue

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥–∏—Ç –ª–∏ –≥–æ—Ä–æ–¥ –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã
        for region in selected_regions:
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            region_normalized = normalize_city_name(region)
            parent_normalized = normalize_city_name(parent) if parent else ""
            city_name_normalized = normalize_city_name(city_name)

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–ß–ù–û–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –∞ –Ω–µ substring matching
            # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ú–æ—Å–∫–≤–∞" in "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å")
            if (region_normalized == parent_normalized or
                region_normalized == city_name_normalized):
                # –ü–æ–ª—É—á–∞–µ–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
                utc_offset = city_info.get('utc_offset', '')

                # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É —Å –ú–æ—Å–∫–≤–æ–π (UTC+3)
                moscow_offset = 3
                city_offset_hours = 0
                if utc_offset:
                    try:
                        # –ü–∞—Ä—Å–∏–º —Å–º–µ—â–µ–Ω–∏–µ –≤–∏–¥–∞ "+03:00" –∏–ª–∏ "-05:00"
                        sign = 1 if utc_offset[0] == '+' else -1
                        hours = int(utc_offset[1:3])
                        city_offset_hours = sign * hours
                    except (ValueError, IndexError, TypeError) as e:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å UTC offset '{utc_offset}': {e}")
                        city_offset_hours = 0

                diff_with_moscow = city_offset_hours - moscow_offset

                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥
                region = parent if parent else '–†–æ—Å—Å–∏—è'
                federal_district = get_federal_district_by_region(region)

                # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å–µ–ª–µ–Ω–∏–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è (0 –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç)
                population = population_dict.get(city_name, 0)

                cities.append({
                    '–ì–æ—Ä–æ–¥': city_name,
                    'ID HH': city_info['id'],
                    '–†–µ–≥–∏–æ–Ω': region,
                    '–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥': federal_district,
                    'UTC': utc_offset,
                    '–†–∞–∑–Ω–∏—Ü–∞ —Å –ú–°–ö': f"{diff_with_moscow:+d}—á" if diff_with_moscow != 0 else "0—á",
                    '–ù–∞—Å–µ–ª–µ–Ω–∏–µ': population
                })
                break

    # –°–æ–∑–¥–∞–µ–º DataFrame
    df = pd.DataFrame(cities)

    # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é –≥–æ—Ä–æ–¥–∞
    if not df.empty:
        df['_–≥–æ—Ä–æ–¥_normalized'] = df['–ì–æ—Ä–æ–¥'].apply(normalize_city_name)
        df = df.drop_duplicates(subset=['_–≥–æ—Ä–æ–¥_normalized'], keep='first')
        df = df.drop(columns=['_–≥–æ—Ä–æ–¥_normalized'])

    return df


def get_all_cities(hh_areas: Dict) -> pd.DataFrame:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –≥–æ—Ä–æ–¥–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ HH (—Ç–æ–ª—å–∫–æ –†–æ—Å—Å–∏—è, —Ç–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–∞)

    –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞ get_cities_by_regions, –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –í–°–ï –≥–æ—Ä–æ–¥–∞ –†–æ—Å—Å–∏–∏
    –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º.

    Args:
        hh_areas: –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤ HH.ru (–∏–∑ get_hh_areas)

    Returns:
        pd.DataFrame: DataFrame —Å–æ –≤—Å–µ–º–∏ –≥–æ—Ä–æ–¥–∞–º–∏ –†–æ—Å—Å–∏–∏ –∏ —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏:
                     - –ì–æ—Ä–æ–¥: –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
                     - ID HH: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ HH.ru
                     - –†–µ–≥–∏–æ–Ω: –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞
                     - –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥: –Ω–∞–∑–≤–∞–Ω–∏–µ –§–û
                     - UTC: —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
                     - –†–∞–∑–Ω–∏—Ü–∞ —Å –ú–°–ö: —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —á–∞—Å–∞—Ö —Å –ú–æ—Å–∫–≤–æ–π
                     - –ù–∞—Å–µ–ª–µ–Ω–∏–µ: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—è

    Examples:
        >>> areas = get_hh_areas()
        >>> all_cities_df = get_all_cities(areas)
        >>> print(f"–í—Å–µ–≥–æ –≥–æ—Ä–æ–¥–æ–≤: {len(all_cities_df)}")
    """
    cities = []

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞—Å–µ–ª–µ–Ω–∏–∏
    population_dict = load_population_data()

    # –°–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π - —á—Ç–æ –Ω–µ –≤—ã–≥—Ä—É–∂–∞—Ç—å (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è)
    excluded_names_normalized = [
        normalize_city_name('–†–æ—Å—Å–∏—è'),
        normalize_city_name('–î—Ä—É–≥–∏–µ —Ä–µ–≥–∏–æ–Ω—ã'),
        normalize_city_name('–î—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω—ã'),
        normalize_city_name('–ß—É–∫–æ—Ç—Å–∫–∏–π –ê–û'),
        normalize_city_name('–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û'),
        normalize_city_name('–ù–µ–Ω–µ—Ü–∫–∏–π –ê–û'),
        normalize_city_name('–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –ê–û - Yug—Ä–∞'),
        normalize_city_name('–ï–≤—Ä–µ–π—Å–∫–∞—è –ê–û'),
        normalize_city_name('–ë–µ–ª–æ–≤—Å–∫–æ–µ'),
        normalize_city_name('–ì–æ—Ä—å–∫–∞—è –ë–∞–ª–∫–∞')
    ]

    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ —Ä–µ–≥–∏–æ–Ω, –∞ –Ω–µ –≥–æ—Ä–æ–¥
    region_keywords = ['–æ–±–ª–∞—Å—Ç—å', '–∫—Ä–∞–π', '—Ä–µ—Å–ø—É–±–ª–∏–∫–∞', '–æ–∫—Ä—É–≥', '–∞–≤—Ç–æ–Ω–æ–º–Ω']

    # ID –†–æ—Å—Å–∏–∏
    russia_id = '113'

    for city_name, city_info in hh_areas.items():
        parent = city_info['parent']
        root_parent_id = city_info.get('root_parent_id', '')

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å—ë, —á—Ç–æ –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –†–æ—Å—Å–∏–∏
        if root_parent_id != russia_id:
            continue

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
        city_name_normalized = normalize_city_name(city_name)

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)
        if city_name_normalized in excluded_names_normalized:
            continue

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–ª–∞—Å—Ç–∏, –∫—Ä–∞—è, —Ä–µ—Å–ø—É–±–ª–∏–∫–∏
        if not parent or parent == '–†–æ—Å—Å–∏—è':
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ–±–ª–∞—Å—Ç—å—é/–∫—Ä–∞–µ–º/—Ä–µ—Å–ø—É–±–ª–∏–∫–æ–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
            is_region = any(keyword in city_name_normalized for keyword in region_keywords)
            if is_region:
                continue

            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ "–ê–û" –∏ —ç—Ç–æ –Ω–µ –≥–æ—Ä–æ–¥
            if city_name.endswith(' –ê–û') or city_name.endswith('–ê–û'):
                continue

        # –ü–æ–ª—É—á–∞–µ–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
        utc_offset = city_info.get('utc_offset', '')

        # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É —Å –ú–æ—Å–∫–≤–æ–π (UTC+3)
        moscow_offset = 3
        city_offset_hours = 0
        if utc_offset:
            try:
                # –ü–∞—Ä—Å–∏–º —Å–º–µ—â–µ–Ω–∏–µ –≤–∏–¥–∞ "+03:00" –∏–ª–∏ "-05:00"
                sign = 1 if utc_offset[0] == '+' else -1
                hours = int(utc_offset[1:3])
                city_offset_hours = sign * hours
            except (ValueError, IndexError, TypeError) as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å UTC offset '{utc_offset}': {e}")
                city_offset_hours = 0

        diff_with_moscow = city_offset_hours - moscow_offset

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥
        region = parent if parent else '–†–æ—Å—Å–∏—è'
        federal_district = get_federal_district_by_region(region)

        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å–µ–ª–µ–Ω–∏–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è (0 –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç)
        population = population_dict.get(city_name, 0)

        cities.append({
            '–ì–æ—Ä–æ–¥': city_name,
            'ID HH': city_info['id'],
            '–†–µ–≥–∏–æ–Ω': region,
            '–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥': federal_district,
            'UTC': utc_offset,
            '–†–∞–∑–Ω–∏—Ü–∞ —Å –ú–°–ö': f"{diff_with_moscow:+d}—á" if diff_with_moscow != 0 else "0—á",
            '–ù–∞—Å–µ–ª–µ–Ω–∏–µ': population
        })

    # –°–æ–∑–¥–∞–µ–º DataFrame
    df = pd.DataFrame(cities)

    # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é –≥–æ—Ä–æ–¥–∞
    if not df.empty:
        df['_–≥–æ—Ä–æ–¥_normalized'] = df['–ì–æ—Ä–æ–¥'].apply(normalize_city_name)
        df = df.drop_duplicates(subset=['_–≥–æ—Ä–æ–¥_normalized'], keep='first')
        df = df.drop(columns=['_–≥–æ—Ä–æ–¥_normalized'])

    return df
